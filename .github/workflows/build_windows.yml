# Build from source on Windows using MSBuild.
name: build_windows
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
permissions: read-all
jobs:
  build_msbuild:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
        - target: 'vs2022'
          vs_version: '2022'
          platform: 'Win32'
          configuration: 'Release'
          vs_tools_options: '--extend-with-x64 --no-python-dll --with-dokany'
        - target: 'vs2022-x64'
          vs_version: '2022'
          platform: 'x64'
          configuration: 'Release'
          vs_tools_options: '--extend-with-x64 --no-python-dll --with-dokany'
        - target: 'vs2022-vsdebug'
          vs_version: '2022'
          platform: 'Win32'
          configuration: 'VSDebug'
          vs_tools_options: '--extend-with-x64 --no-python-dll --with-dokany'
        - target: 'vs2022-python'
          vs_version: '2022'
          platform: 'x64'
          configuration: 'Release'
          vs_tools_options: '--extend-with-x64 --with-dokany'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: libewf

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: 'x64'

    - name: Set up MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Sync win_flex_bison
      working-directory: libewf
      shell: pwsh
      run: .\syncwinflexbison.ps1

    - name: Sync test data
      working-directory: libewf
      shell: pwsh
      run: |
        if (Test-Path ".\synctestdata.ps1") { .\synctestdata.ps1 }

    - name: Sync zlib
      working-directory: libewf
      shell: pwsh
      run: .\synczlib.ps1

    - name: Clone bzip2
      shell: pwsh
      run: |
        git clone https://github.com/joachimmetz/bzip2.git "${{ github.workspace }}\bzip2"

    - name: Sync and build dokan
      working-directory: libewf
      shell: pwsh
      run: |
        .\syncdokan.ps1
        $vcxproj = "${{ github.workspace }}\dokany\dokan\dokan.vcxproj"
        if (Test-Path $vcxproj) {
          $content = Get-Content $vcxproj -Raw
          $content = $content -Replace '<PlatformToolset>v14[0-9]</PlatformToolset>', '<PlatformToolset>v143</PlatformToolset>'
          $content = $content -Replace '<WindowsTargetPlatformVersion>[^<]+</WindowsTargetPlatformVersion>', '<WindowsTargetPlatformVersion>10.0</WindowsTargetPlatformVersion>'
          Set-Content $vcxproj $content
        }
        $env:APPVEYOR = "True"
        .\builddokan.ps1 -Configuration Release -Platform Win32
        .\builddokan.ps1 -Configuration Release -Platform x64
        $dokanyRoot = "${{ github.workspace }}\dokany"
        Write-Host "=== Dokan build output ==="
        Get-ChildItem -Path $dokanyRoot -Recurse -Include "dokan*.lib","dokan*.dll" -ErrorAction SilentlyContinue |
          Select-Object -ExpandProperty FullName

        # Strategy A: create legacy 'dokan' tree at $WORKSPACE/dokan so that original
        # msvscpp paths (../../../dokan/...) still resolve after vstools conversion when
        # --with-dokany is not recognised and paths are left unchanged.
        $legacyRoot = "${{ github.workspace }}\dokan"
        # Copy headers: dokan/dokan/*.h
        $headerSrc = "$dokanyRoot\dokan"
        $headerDst = "$legacyRoot\dokan"
        New-Item -ItemType Directory -Force -Path $headerDst | Out-Null
        Get-ChildItem -Path $headerSrc -Filter "*.h" -ErrorAction SilentlyContinue |
          ForEach-Object { Copy-Item $_.FullName -Destination "$headerDst\$($_.Name)" -Force }
        # Copy libs: dokan/msvscpp/<config>/dokan.lib  ($(ConfigurationName) = Release / VSDebug)
        foreach ($platform in @("Win32", "x64")) {
          $libSrc = "$dokanyRoot\dokan\$platform\Release\dokan2.lib"
          $dllSrc = "$dokanyRoot\dokan\$platform\Release\dokan2.dll"
          foreach ($config in @("Release", "VSDebug")) {
            $destDir = "$legacyRoot\msvscpp\$config"
            New-Item -ItemType Directory -Force -Path $destDir | Out-Null
            if (Test-Path $libSrc) {
              Copy-Item $libSrc -Destination "$destDir\dokan.lib"  -Force
              Copy-Item $libSrc -Destination "$destDir\dokan2.lib" -Force
            }
            if (Test-Path $dllSrc) {
              Copy-Item $dllSrc -Destination "$destDir\dokan.dll"  -Force
              Copy-Item $dllSrc -Destination "$destDir\dokan2.dll" -Force
            }
          }
          Write-Host "Legacy dokan tree created for $platform"
        }

        # Strategy B: stage at dokany paths for when vstools does convert the references.
        foreach ($platform in @("Win32", "x64")) {
          $libSrc = "$dokanyRoot\dokan\$platform\Release\dokan2.lib"
          if (Test-Path $libSrc) {
            $destDir = "$dokanyRoot\$platform\Release"
            New-Item -ItemType Directory -Force -Path $destDir | Out-Null
            Copy-Item $libSrc -Destination "$destDir\dokan2.lib" -Force
            Copy-Item $libSrc -Destination "$destDir\dokan.lib"  -Force
            Write-Host "Staged dokan2.lib -> $destDir"
          }
        }

    - name: Sync dependency libraries
      working-directory: libewf
      shell: pwsh
      run: .\synclibs.ps1

    - name: Generate build files
      working-directory: libewf
      shell: pwsh
      run: .\autogen.ps1

    - name: Build
      working-directory: libewf
      shell: pwsh
      run: |
        $PythonPath = (Get-Command python).Source | Split-Path
        .\build.ps1 `
          -VisualStudioVersion ${{ matrix.vs_version }} `
          -Configuration ${{ matrix.configuration }} `
          -Platform ${{ matrix.platform }} `
          -PythonPath $PythonPath `
          -VSToolsOptions "${{ matrix.vs_tools_options }}"
        $vsDir = "vs${{ matrix.vs_version }}"
        $conf = "${{ matrix.configuration }}"
        $plat = "${{ matrix.platform }}"
        $outputDir = "${vsDir}\${conf}\${plat}"
        if (-not (Test-Path $outputDir)) { $outputDir = "${vsDir}\${conf}" }
        if (-not (Test-Path $outputDir)) {
          Write-Error "Build output directory not found (${vsDir}\${conf}\${plat}). MSBuild may have failed silently."
          exit 1
        }
        Write-Host "Build output directory: $outputDir"
        # Copy dokan2.dll alongside ewfmount.exe so it is runnable and included in the artifact
        $dokanyRoot = "${{ github.workspace }}\dokany"
        $dokanDll = Get-ChildItem -Path $dokanyRoot -Recurse -Filter "dokan*.dll" -ErrorAction SilentlyContinue |
                      Where-Object { $_.FullName -match [regex]::Escape($plat) } |
                      Select-Object -First 1
        if (-not $dokanDll) {
          $dokanDll = Get-ChildItem -Path $dokanyRoot -Recurse -Filter "dokan*.dll" -ErrorAction SilentlyContinue |
                        Select-Object -First 1
        }
        if ($dokanDll) {
          Copy-Item $dokanDll.FullName -Destination "$outputDir\$($dokanDll.Name)" -Force
          Write-Host "Copied $($dokanDll.Name) to $outputDir"
        } else {
          Write-Warning "dokan DLL not found; ewfmount may not run without it"
        }

    - name: Diagnose ewfmount
      working-directory: libewf
      shell: pwsh
      run: |
        $vsDir = "vs${{ matrix.vs_version }}"
        $conf  = "${{ matrix.configuration }}"
        $plat  = "${{ matrix.platform }}"
        $proj  = "$vsDir\ewfmount\ewfmount.vcxproj"
        if (Test-Path $proj) {
          Write-Host "=== ewfmount.vcxproj dokan references ==="
          Get-Content $proj | Where-Object { $_ -match "(?i)dokan" } | Write-Host
        } else {
          Write-Warning "ewfmount.vcxproj was NOT generated (msvscpp_convert.py may not support --with-dokany)"
        }
        Write-Host "=== ewfmount.exe search ==="
        Get-ChildItem -Path $vsDir -Recurse -Filter "ewfmount.exe" -ErrorAction SilentlyContinue |
          Select-Object -ExpandProperty FullName

    - name: Run tests
      working-directory: libewf
      shell: pwsh
      run: .\runtests.ps1

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libewf-${{ matrix.target }}
        path: |
          libewf/vs${{ matrix.vs_version }}/${{ matrix.configuration }}/${{ matrix.platform }}/*.exe
          libewf/vs${{ matrix.vs_version }}/${{ matrix.configuration }}/${{ matrix.platform }}/*.dll
          libewf/vs${{ matrix.vs_version }}/${{ matrix.configuration }}/${{ matrix.platform }}/*.pdb
          libewf/vs${{ matrix.vs_version }}/${{ matrix.configuration }}/*.exe
          libewf/vs${{ matrix.vs_version }}/${{ matrix.configuration }}/*.dll
          libewf/vs${{ matrix.vs_version }}/${{ matrix.configuration }}/*.pdb
        if-no-files-found: warn
